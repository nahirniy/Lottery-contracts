# Solidity API

## Lottery

Manages lottery functionality including ticket registration, initialization, running, and rewarding winners.
The lottery has 3 tiers type - jackpot, random and fixed. 
Winners are selected from registered tickets using a specific algorithm that relies on a random number generated
by the Chainlink VRF to ensure randomness, then receive a reward in their wallet.

### REGISTRAR_ROLE

```solidity
bytes32 REGISTRAR_ROLE
```

Сonstant that contains the REGISTRAR role. Owner of this role can registet ticket contracts.

### REWARDER_ROLE

```solidity
bytes32 REWARDER_ROLE
```

Сonstant that contains the REWARDER role. Owner of this role can reward winners who exceeded the lottery cap.

### BIPS

```solidity
uint256 BIPS
```

Basis points. Used to calculate the amount of winners.

### mintDeadline

```solidity
uint32 mintDeadline
```

Retrieves the deadline for minting tickets.

### burnDeadline

```solidity
uint32 burnDeadline
```

Retrieves the deadline for burning tickets.

### lotteryTime

```solidity
uint32 lotteryTime
```

Retrieves the timestamp indicating the time when the lottery can run.

### lotteryTicketsTotalSupply

```solidity
uint256 lotteryTicketsTotalSupply
```

Total supply of tickets participating in the lottery.

### randomSalt

```solidity
uint256 randomSalt
```

Random number generated by chainlink VRF.

### requestRandomNumberId

```solidity
uint256 requestRandomNumberId
```

Request ID by which it is possible to get a random number.

### organizations

```solidity
address[] organizations
```

Addresses of organizations participating in the lottery.

### organizationSharesForFixedTiers

```solidity
uint256[] organizationSharesForFixedTiers
```

An array of each organization's shares.

### initializedOrganizationsCount

```solidity
uint256 initializedOrganizationsCount
```

The amount of initialized organizations

### isRegisteredTicket

```solidity
mapping(address => bool) isRegisteredTicket
```

Mapping that contains registered addresses of tickets.

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |

### isOrganizationAdded

```solidity
mapping(address => bool) isOrganizationAdded
```

Mapping that contains added organization.

### organizationTicketsContracts

```solidity
mapping(address => address[]) organizationTicketsContracts
```

Mapping that contains array of ticket contracts associated with an organization address.

### organizationTicketsRange

```solidity
mapping(address => struct ILottery.TicketRange) organizationTicketsRange
```

Mapping that contains the ticket range associated with an organization.

### allCampaignTickets

```solidity
struct ILottery.CampaignTickets[] allCampaignTickets
```

Array containing tickets of each campaign and TicketRange.

### tiers

```solidity
struct ILottery.Tier[] tiers
```

Array containing configuration of lottery tiers

_Each `Tier` struct defines a tier with attributes such as type, percentage share of winners, amount of winners, and reward amount._

### processedTiersCount

```solidity
uint256 processedTiersCount
```

The amount of tiers for that rewards have already been sent to winners.

### rewardToken

```solidity
contract IERC20 rewardToken
```

Token contract for rewards.

### randomGetter

```solidity
contract IRandomGetter randomGetter
```

randomGetter contract that is responsible for obtaining a random number.

### winners

```solidity
uint256[] winners
```

Array contains the lottery ticket IDs that.

### overCapWinners

```solidity
uint256[] overCapWinners
```

Array contains the lottery ticket IDs that won more than the lottery cap.

### overCapWinnerAmount

```solidity
mapping(uint256 => uint256) overCapWinnerAmount
```

Mapping that contains the winners who won more than the lottery cap.

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |

### winnerAmount

```solidity
mapping(uint256 => uint256) winnerAmount
```

Mapping that contains the winner amount associated with a ticket ID.

### tierWinners

```solidity
mapping(uint256 => uint256[]) tierWinners
```

Mapping that contains array of winners associated with a tier index.

### lotteryProcessed

```solidity
bool lotteryProcessed
```

Flag indicating whether the lottery has been completely processed (all tiers).

### constructor

```solidity
constructor(address _defaultAdmin, address _registrar, address _randomGetter, uint32 _mintDeadline, uint32 _burnDeadline, uint32 _lotteryTime) public
```

Constructor function to initialize the Lottery contract.

_Reverts if the provided time values are incorrect._

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| _defaultAdmin | address | The address of the admin this contract. |
| _registrar | address | The address of the registrar role (expected to be the factory contract). |
| _randomGetter | address | The address of the contract providing random numbers. |
| _mintDeadline | uint32 | The timestamp indicating the deadline for minting tickets. |
| _burnDeadline | uint32 | The timestamp indicating the deadline for burning tickets. |
| _lotteryTime | uint32 | The timestamp indicating the time when the lottery can be run. |

### registerTicketContract

```solidity
function registerTicketContract(address _ticketContract) external
```

This function registers a ticket contract for the lottery.

_Only can be called by accounts with the REGISTRAR_ROLE.
Reverts if the ticket contract does not support the IRootsyTicket interface.
Add the organization of the ticket to all organizations_

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| _ticketContract | address | The address of the ticket contract to register. |

### setupLottery

```solidity
function setupLottery(address _rewardToken, uint256 _lotteryCap, struct ILottery.Tier[] _tiers, uint256[] _organizationSharesForFixedTiers) external
```

This function sets up the lottery with specified parameters such as reward token, tiers and shares of organizations.
Part of winners for each organization depends on its shares.
The tiers contain information about each tier, such as type, amount of winners, reward amount.

_Each element in `_tiers` is defined by its type (jackpot, random and fixed), the amount of winners and the reward amount.
Each element in the `_organizationSharesForFixedTiers` is the percentage share of an organization for fixed tiers.
Total share is 100_00 corresponds to 100% (BIPS).
This function must be called before the lottery time.
Only can be called by accounts with the DEFAULT_ADMIN_ROLE.
Reverts if the reward token is not a contract.
Reverts if the amount of organization shares for fixed tiers does not match the amount of organizations.
Reverts if there are any incorrect tier configurations or if the total organization shares don't sum up to 100%._

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| _rewardToken | address | The address of the token used as rewards. |
| _lotteryCap | uint256 | Maximum amount a single winner can receive. |
| _tiers | struct ILottery.Tier[] | An array containing the configuration of lottery tiers. |
| _organizationSharesForFixedTiers | uint256[] | An array containing the percentage shares of organizations for fixed tiers. |

### initializeLottery

```solidity
function initializeLottery(uint256 organizationsCount) external
```

This function initializes the lottery by assigning ticket ranges to each organization's tickets.
This function initializes a specified number of organizations to avoid exceeding gas limits when dealing with many organizations.

_If the gas limit is exceeded when calling the function, the organization must be initialized in parts.
This function can be called when the burn deadline passed, since after that amount of tickets cannot be changed.
This function can be called if lottery hasn't been fully initialized.
Calculates the amount of winners for random tier based on the total supply of lottery tickets.
If `organizationsCount` is 0 or exceeds the remaining amount of organizations to initialize,
it automatically sets `organizationsCount` to the remaining amount of organizations._

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| organizationsCount | uint256 | The amount of organizations to initialize in the lottery. |

### runLottery

```solidity
function runLottery() external
```

This function run the lottery process. 
This function makes a request for a random number. Later, winners are selected based on this random number.

_This function can be called when the lottery time reached.
This function doesn't include selecting winners or distributing rewards.
Reverts if the function was called before and the `requestRandomNumberId` was received.
Reverts if the lottery is not fully initialized with all organizations._

### rewardWinners

```solidity
function rewardWinners(uint256 tiersCount) external
```

This function rewards the winners of the lottery tiers apart from who won more than the lottery cap.
This function randomly selects winners from registered tickets based on a random number.
This function rewards a specified amoumt of tiers to avoid exceeding gas limits when dealing with many tiers.
This function rewards a specified amoumt of tiers to avoid exceeding gas limits when dealing with many tiers.

_If the gas limit is exceeded when calling the function, the tiers should be rewarded in parts.
Winners are chosen based on a random number.
Transfer tokens to winners.
Reverts if a random number is still pending or if the lottery is not yet run.
Reverts if the lottery has already been processed.
If the tier is of type `Fixed`, it distributes rewards among the winners based on their organization's shares.
If `tiersCount` is 0 or exceeds the remaining amount of tiers to initialize,
it automatically sets `tiersCount` to the remaining amount of tiers._

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| tiersCount | uint256 | The number of tiers to process. |

### rewardOverCapWinners

```solidity
function rewardOverCapWinners(uint256[] lotteryTicketIds) external
```

This function rewards the over cap winners based on the provided lottery ticket IDs.

_This function only can be called by accounts with the REWARDER_ROLE._

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| lotteryTicketIds | uint256[] | An array of lottery ticket IDs whose holders will receive rewards. |

### rewardOverCapWinner

```solidity
function rewardOverCapWinner(uint256 lotteryTicketId) external
```

This function rewards the over cap winner based on the provided lottery ticket ID.

_This function only can be called by accounts with the REWARDER_ROLE._

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| lotteryTicketId | uint256 | lottery ticket IDs who holder will receive reward. |

### getUnderlyingTicket

```solidity
function getUnderlyingTicket(uint256 lotteryTicketId) public view returns (address, uint256)
```

Retrieves the underlying ticket information for a given lottery ticket ID.

_Uses a binary search algorithm to efficiently locate the corresponding campaign ticket contract._

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| lotteryTicketId | uint256 | The ID of the lottery ticket. |

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | address | The address of the ticket contract. |
| [1] | uint256 | The ticket ID within ticket contract. |

### getLotteryTicketId

```solidity
function getLotteryTicketId(address campaign, uint256 ticketId) public view returns (uint256)
```

Retrieves the lottery ticket ID for a given campaign and ticket ID.

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| campaign | address | The address of the campaign contract which owns the ticket. |
| ticketId | uint256 | The ID of the ticket within the campaign that will be converted to a lottery ticket ID. |

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256 | lotteryTicketId The calculated lottery ticket ID which participates in the lottery. |

### getTier

```solidity
function getTier(uint256 tierIndex) public view returns (struct ILottery.Tier)
```

Retrieves information about a specific tier in the lottery.

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| tierIndex | uint256 | The index of the tier to retrieve. |

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | struct ILottery.Tier | Tier information including tier type, winners count, reward amount, etc. |

### getAllTiers

```solidity
function getAllTiers() public view returns (struct ILottery.Tier[])
```

Retrieves information about all tiers in the lottery.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | struct ILottery.Tier[] | An array containing information about all tiers including tier type, winners count, reward amount, etc. |

### getAllOrganizations

```solidity
function getAllOrganizations() public view returns (address[])
```

Retrieves the addresses of all organizations participating in the lottery.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | address[] | An array containing the addresses of all participating organizations. |

### getAllWinners

```solidity
function getAllWinners() external view returns (uint256[])
```

Retrieves all lottery winners.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256[] | An array of lottery ticket IDs that won. |

### getAllOverCapWinners

```solidity
function getAllOverCapWinners() external view returns (uint256[])
```

Retrieves all over-cap winners.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256[] | An array of lottery ticket IDs that won more than the lottery cap. |

### getTiersCount

```solidity
function getTiersCount() public view returns (uint256)
```

Retrieves the amount of tiers in the lottery.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256 | The amount of tiers in the lottery. |

### getOrganizationsCount

```solidity
function getOrganizationsCount() public view returns (uint256)
```

Retrieves the amount of organizations participating in the lottery.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256 | The amount of participating organizations. |

### getWinnersCount

```solidity
function getWinnersCount() external view returns (uint256)
```

Retrieves the count of lottery winners.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256 | The number of lottery ticket IDs that won. |

### getOverCapWinnersCount

```solidity
function getOverCapWinnersCount() external view returns (uint256)
```

Retrieves the count of over-cap winners.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256 | The number of lottery ticket IDs that won more than the lottery cap. |

### getOrganizationTicketsContracts

```solidity
function getOrganizationTicketsContracts(address organization) public view returns (address[])
```

Retrieves the addresses of all ticket contracts associated with a specific organization.

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| organization | address | The address of the organization. |

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | address[] | An array containing the addresses of ticket contracts associated with the organization. |

### getOrganizationSharesForFixedTiers

```solidity
function getOrganizationSharesForFixedTiers() public view returns (uint256[])
```

Retrieves the shares assigned to each organization for fixed tiers.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256[] | An array containing the shares assigned to each organization for fixed tiers. |

### getAllCampaignTickets

```solidity
function getAllCampaignTickets() public view returns (struct ILottery.CampaignTickets[])
```

Retrieves all campaign tickets stored in the lottery.

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | struct ILottery.CampaignTickets[] | An array containing all campaign tickets stored in the lottery. |

### _checkTickedIsNotWinner

```solidity
function _checkTickedIsNotWinner(uint256 lotteryTicketId) internal view returns (uint256)
```

Recursively checks if the ticket with the given ID is not a winner.

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| lotteryTicketId | uint256 | The ID of the lottery ticket to check. |

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| [0] | uint256 | The ID of the first non-winning ticket found after the provided ID. |

### _rewardWinnersForTier

```solidity
function _rewardWinnersForTier(uint256 startTicketId, uint256 endTicketId, uint256 tierIndex, struct ILottery.Tier tier) internal returns (uint256 tierTotalRewardAmount)
```

This function randomly selects winners from registered tickets based on a random number and rewards them.

#### Parameters

| Name | Type | Description |
| ---- | ---- | ----------- |
| startTicketId | uint256 | The starting ID of the lottery tickets range. |
| endTicketId | uint256 | The ending ID of the lottery tickets range. |
| tierIndex | uint256 | The index of the tier. |
| tier | struct ILottery.Tier | The details of the tier. |

#### Return Values

| Name | Type | Description |
| ---- | ---- | ----------- |
| tierTotalRewardAmount | uint256 | The total amount rewarded for the tier. |

### supportsInterface

```solidity
function supportsInterface(bytes4 interfaceId) public view returns (bool)
```

_Returns true if this contract implements the interface defined by
`interfaceId`. See the corresponding
https://eips.ethereum.org/EIPS/eip-165#how-interfaces-are-identified[EIP section]
to learn more about how these ids are created.

This function call must use less than 30 000 gas._

